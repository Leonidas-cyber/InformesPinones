<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial - Congregación Arrayanes</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="StylesInformacion.css">
    <link rel="stylesheet" href="stylesAdm.css">
    <link rel="stylesheet" href="secretario.css">
    <link rel="stylesheet" href="historial.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
</head>
<body>

    <div class="loading-screen">
        <div class="loading-content">
            <h1>Historial Arrayanes</h1>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <div class="main-content">
        <div class="content admin-container">
            <h1 class="admin-title">Historial de Actividades</h1>
            <p>Consulta y filtra los registros históricos de la congregación</p>

            <div class="admin-alert" id="historialAlert"></div>

            <!-- Sección para subir informes anteriores -->
            <div class="upload-section">
                <h2><i class="fas fa-file-excel"></i> Subir Informes Anteriores</h2>
                <p>Sube archivos Excel con informes desde marzo 2025</p>
                
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Arrastra y suelta tus archivos Excel aquí o haz clic para seleccionar</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" multiple>
                    <div class="file-info" id="fileInfo">No se han seleccionado archivos</div>
                </div>
                
                <div class="button-group">
                    <button id="uploadFiles" class="historial-btn upload-btn" disabled>
                        <i class="fas fa-upload"></i> Subir Archivos
                    </button>
                </div>
                
                <div class="file-list" id="fileListContainer" style="display: none;">
                    <h4>Archivos seleccionados:</h4>
                    <div id="fileList"></div>
                </div>
            </div>


            <!-- Sección para mostrar archivos en Storage -->
            <div class="storage-files-container">
                <div class="storage-files-header">
                    <h3><i class="fas fa-folder-open"></i> Archivos en Storage</h3>
                    <button id="refreshStorage" class="historial-btn secondary-btn">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div class="storage-file-list" id="storageFileList">
                    <!-- Los archivos de Storage se cargarán aquí -->
                </div>
                
                <div class="storage-loading" id="storageLoading" style="display: none;">
                    <div class="historial-spinner"></div>
                    <p>Cargando archivos...</p>
                </div>
                
                <div class="storage-empty" id="storageEmpty" style="display: none;">
                    <i class="fas fa-folder-open"></i>
                    <p>No se encontraron archivos en el Storage</p>
                </div>
            </div>

            <!-- Detalles de actividad modal -->
            <div id="activityDetailModal" class="activity-modal">
                <div class="activity-modal-content">
                    <div class="activity-modal-header">
                        <h3>Detalles de la Actividad</h3>
                        <button class="close-modal"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="activity-modal-body" id="activityModalBody">
                        <!-- Los detalles se cargarán dinámicamente aquí -->
                    </div>
                    <div class="activity-modal-footer">
                        <button class="historial-btn secondary-btn close-modal">Cerrar</button>
                    </div>
                </div>
            </div>

            <!-- Modal de confirmación de eliminación -->
            <div id="deleteModal" class="delete-modal">
                <div class="delete-modal-content">
                    <div class="delete-modal-header">
                        <h3><i class="fas fa-exclamation-triangle"></i> Confirmar eliminación</h3>
                        <button class="close-delete-modal"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="delete-modal-body">
                        <p>¿Estás seguro de que deseas eliminar este archivo permanentemente?</p>
                        <p class="file-name-confirm"></p>
                    </div>
                    <div class="delete-modal-footer">
                        <button class="historial-btn secondary-btn cancel-delete">Cancelar</button>
                        <button class="historial-btn danger-btn confirm-delete">Eliminar</button>
                    </div>
                </div>
            </div>

            <!-- Botón de volver -->
            <div class="back-section">
                <a href="./administracion.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i> Volver a Administración
                </a>
            </div>
        </div>
    </div>

    <script src="/script.js" type="module"></script>
    <script src="/ScriptLogin.js" type="module"></script>

    <script>
        fetch("/menuadm.html")
            .then(response => response.text())
            .then(data => {
                document.body.insertAdjacentHTML("afterbegin", data);    
            });
    </script>
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyANSEcsrnbzVJ8i6-eOqv-pewPaeImdORg",
            authDomain: "pinones-congre.firebaseapp.com",
            databaseURL: "https://pinones-congre-default-rtdb.firebaseio.com",
            projectId: "pinones-congre",
            storageBucket: "pinones-congre.appspot.com",
            messagingSenderId: "1031984043314",
            appId: "1:1031984043314:web:49b38b2c60d69601d3732b",
            measurementId: "G-SR373KE6RX"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // Variables globales
        let selectedFiles = [];
        let currentUser = null;
        let storageFiles = [];

        // Esperar a que cargue el DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos del DOM
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const uploadFilesBtn = document.getElementById('uploadFiles');
            const fileListContainer = document.getElementById('fileListContainer');
            const fileList = document.getElementById('fileList');
            const historialAlert = document.getElementById('historialAlert');
            const refreshStorageBtn = document.getElementById('refreshStorage');
            const storageFileList = document.getElementById('storageFileList');
            const storageLoading = document.getElementById('storageLoading');
            const storageEmpty = document.getElementById('storageEmpty');

            // Verificar autenticación
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadStorageFiles(); // Cargar archivos al autenticar
                } else {
                    window.location.href = '/login.html';
                }
            });

            // Evento para actualizar la lista de archivos
            refreshStorageBtn.addEventListener('click', loadStorageFiles);

            // Eventos para la subida de archivos
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('active');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('active');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('active');
                handleFiles(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', () => {
                handleFiles(fileInput.files);
            });
            
            uploadFilesBtn.addEventListener('click', uploadFiles);

            // Función para cargar archivos del Storage
            async function loadStorageFiles() {
    try {
        storageLoading.style.display = 'flex';
        storageFileList.innerHTML = '';
        storageEmpty.style.display = 'none';

        // Obtener el mes y año actual para la ruta
        const now = new Date();
        const month = now.getMonth() + 1; // Los meses van de 0 a 11
        const year = now.getFullYear();
        const folderName = `informes/${year}-${month.toString().padStart(2, '0')}`;

        // Listar todos los archivos en la carpeta del mes actual
        const storageRef = storage.ref(folderName);
        const result = await storageRef.listAll();

        storageFiles = [];

        // Procesar cada archivo
        for (const item of result.items) {
            const metadata = await item.getMetadata();
            const downloadUrl = await item.getDownloadURL();

            storageFiles.push({
                name: item.name,
                fullPath: item.fullPath,
                downloadUrl: downloadUrl,
                size: metadata.size,
                timeCreated: metadata.timeCreated,
                contentType: metadata.contentType
            });
        }

        // Mostrar archivos
        if (storageFiles.length === 0) {
            storageEmpty.style.display = 'block';
        } else {
            storageFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'storage-file-item';

                const fileInfo = document.createElement('div');
                fileInfo.className = 'storage-file-info';

                const fileIcon = document.createElement('i');
                fileIcon.className = 'storage-file-icon fas fa-file-excel';

                const fileName = document.createElement('span');
                fileName.className = 'storage-file-name';
                fileName.textContent = file.name;

                const filePath = document.createElement('span');
                filePath.className = 'storage-file-path';
                filePath.textContent = file.fullPath;

                const fileSize = document.createElement('span');
                fileSize.className = 'storage-file-size';
                fileSize.textContent = formatFileSize(file.size);

                const fileActions = document.createElement('div');
                fileActions.className = 'storage-file-actions';

                const downloadBtn = document.createElement('button');
                downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
                downloadBtn.title = 'Descargar';
                downloadBtn.addEventListener('click', () => downloadFile(file.downloadUrl, file.name));

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Eliminar';
                deleteBtn.className = 'delete-btn';
                deleteBtn.addEventListener('click', () => deleteFile(file.fullPath));

                fileActions.appendChild(downloadBtn);
                fileActions.appendChild(deleteBtn);

                fileInfo.appendChild(fileIcon);
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(filePath);

                fileItem.appendChild(fileInfo);
                fileItem.appendChild(fileSize);
                fileItem.appendChild(fileActions);

                storageFileList.appendChild(fileItem);
            });
        }

    } catch (error) {
        console.error('Error al cargar archivos:', error);
        showAlert(`Error al cargar archivos: ${error.message}`, 'error');
    } finally {
        storageLoading.style.display = 'none';
    }
}
        //aqui va la funcion para descargar el archivo , actualmente eliminada

            // Función para eliminar un archivo
            // Función para eliminar un archivo
async function deleteFile(filePath) {
    try {
        // Mostrar modal de confirmación
        const confirmed = await showDeleteConfirmation(filePath.split('/').pop());
        if (!confirmed) return;

        const fileRef = storage.ref(filePath);
        await fileRef.delete();
        
        // Registrar la actividad en Firestore
        await db.collection('historial').add({
            fecha: firebase.firestore.FieldValue.serverTimestamp(),
            usuario: currentUser.email,
            actividad: 'fileDelete',
            detalles: {
                nombreArchivo: filePath.split('/').pop(),
                ruta: filePath
            }
        });
        
        showAlert('Archivo eliminado correctamente', 'success');
        loadStorageFiles(); // Recargar la lista
    } catch (error) {
        console.error('Error al eliminar archivo:', error);
        showAlert(`Error al eliminar archivo: ${error.message}`, 'error');
    }
}

// Función para mostrar el modal de confirmación
function showDeleteConfirmation(fileName) {
    return new Promise((resolve) => {
        const deleteModal = document.getElementById('deleteModal');
        const confirmBtn = document.querySelector('.confirm-delete');
        const cancelBtn = document.querySelector('.cancel-delete');
        const closeBtn = document.querySelector('.close-delete-modal');
        const fileNameConfirm = document.querySelector('.file-name-confirm');

        fileNameConfirm.textContent = fileName;
        deleteModal.classList.add('active');

        const cleanUp = () => {
            deleteModal.classList.remove('active');
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
            closeBtn.removeEventListener('click', cancelHandler);
            deleteModal.removeEventListener('click', outsideClick);
        };

        const confirmHandler = () => {
            cleanUp();
            resolve(true);
        };

        const cancelHandler = () => {
            cleanUp();
            resolve(false);
        };

        const outsideClick = (e) => {
            if (e.target === deleteModal) {
                cancelHandler();
            }
        };

        confirmBtn.addEventListener('click', confirmHandler);
        cancelBtn.addEventListener('click', cancelHandler);
        closeBtn.addEventListener('click', cancelHandler);
        deleteModal.addEventListener('click', outsideClick);
    });
}

            // Función para manejar los archivos seleccionados
            function handleFiles(files) {
                selectedFiles = Array.from(files).filter(file => {
                    const validTypes = ['application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
                    return validTypes.includes(file.type) || file.name.endsWith('.xls') || file.name.endsWith('.xlsx');
                });
                
                if (selectedFiles.length === 0) {
                    fileInfo.textContent = 'No se han seleccionado archivos Excel válidos';
                    uploadFilesBtn.disabled = true;
                    fileListContainer.style.display = 'none';
                    return;
                }
                
                fileInfo.textContent = `${selectedFiles.length} archivo(s) seleccionado(s)`;
                uploadFilesBtn.disabled = false;
                
                // Mostrar lista de archivos
                fileList.innerHTML = '';
                selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    const fileName = document.createElement('div');
                    fileName.className = 'file-name';
                    fileName.textContent = file.name;
                    
                    const fileSize = document.createElement('div');
                    fileSize.className = 'file-size';
                    fileSize.textContent = formatFileSize(file.size);
                    
                    const fileActions = document.createElement('div');
                    fileActions.className = 'file-actions';
                    
                    const removeIcon = document.createElement('i');
                    removeIcon.className = 'fas fa-times';
                    removeIcon.title = 'Eliminar archivo';
                    removeIcon.addEventListener('click', () => removeFile(index));
                    
                    fileActions.appendChild(removeIcon);
                    fileItem.appendChild(fileName);
                    fileItem.appendChild(fileSize);
                    fileItem.appendChild(fileActions);
                    
                    fileList.appendChild(fileItem);
                });
                
                fileListContainer.style.display = 'block';
            }

            // Función para eliminar un archivo de la lista
            function removeFile(index) {
                selectedFiles.splice(index, 1);
                handleFiles(selectedFiles); // Reprocesar la lista
            }

            // Función para formatear el tamaño del archivo
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
            }

            // Función para subir archivos a Firebase Storage
            async function uploadFiles() {
                if (selectedFiles.length === 0 || !currentUser) return;
                
                uploadFilesBtn.disabled = true;
                uploadFilesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
                
                try {
                    // Crear carpeta con el mes y año actual si no existe
                    const now = new Date();
                    const month = now.getMonth() + 1; // Los meses van de 0 a 11
                    const year = now.getFullYear();
                    const folderName = `informes/${year}-${month.toString().padStart(2, '0')}`;
                    
                    // Subir cada archivo
                    const uploadPromises = selectedFiles.map(file => {
                        const fileName = file.name;
                        const filePath = `${folderName}/${fileName}`;
                        const storageRef = storage.ref(filePath);
                        
                        return storageRef.put(file).then(snapshot => {
                            // Registrar la actividad en Firestore
                            return db.collection('historial').add({
                                fecha: firebase.firestore.FieldValue.serverTimestamp(),
                                usuario: currentUser.email,
                                actividad: 'fileUpload',
                                detalles: {
                                    nombreArchivo: fileName,
                                    ruta: filePath,
                                    tamaño: file.size,
                                    tipo: file.type
                                }
                            });
                        });
                    });
                    
                    await Promise.all(uploadPromises);
                    
                    // Mostrar mensaje de éxito
                    showAlert('Archivos subidos correctamente', 'success');
                    
                    // Limpiar selección
                    selectedFiles = [];
                    fileInput.value = '';
                    fileInfo.textContent = 'No se han seleccionado archivos';
                    fileListContainer.style.display = 'none';
                    
                    // Actualizar la lista de archivos
                    loadStorageFiles();
                    
                } catch (error) {
                    console.error('Error al subir archivos:', error);
                    showAlert(`Error al subir archivos: ${error.message}`, 'error');
                } finally {
                    uploadFilesBtn.disabled = false;
                    uploadFilesBtn.innerHTML = '<i class="fas fa-upload"></i> Subir Archivos';
                }
            }

            // Función para mostrar alertas
            function showAlert(message, type) {
                historialAlert.textContent = message;
                historialAlert.className = `admin-alert ${type}`;
                historialAlert.style.display = 'block';
                
                setTimeout(() => {
                    historialAlert.style.display = 'none';
                }, 5000);
            }
        });
    </script>
</body>
</html>